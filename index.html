<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devagneya's World ‚Äî GreenCityProject</title>
  
  <!-- Link to external stylesheet -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- SEO & Theme Meta Tags -->
  <meta name="description" content="Welcome to Devagneya's World, a creative portfolio inspired by Studio Ghibli. Featuring the GreenCityProject." />
  <meta name="author" content="Devagneya" />
  <meta name="theme-color" content="#aee1f9">
  <link rel="icon" href="/favicon.ico">
</head>
<body>

  <!-- Parallax Background Layers -->
  <div class="layer sky" aria-hidden="true"></div>
  <div class="layer clouds" aria-hidden="true"></div>
  <div class="layer mountains" aria-hidden="true"></div>

  <!-- Floating Foreground Elements -->
  <div class="leaf" aria-hidden="true"></div>
  <div class="lantern" aria-hidden="true"></div>

  <header class="hero">
    <h1 class="hero-title">Devagneya's World</h1>
    <p class="hero-sub">Featured ‚Äî GreenCityProject</p>
  </header>

  <!-- Home video: "Click-to-Load" Pattern (Video stays embedded here) -->
  <section class="home-video" aria-label="GreenCityProject featured video">
    <div id="videoWrapper" class="video-wrapper">
      
      <!-- This block will be replaced by the iframe on click -->
      <div id="videoBlock" class="video-block" role="button" tabindex="0" aria-label="Play GreenCityProject video">
        
        <!-- Large, centered play button -->
        <button id="videoPlayBtn" aria-label="Play video">
          <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
            <polygon points="30,20 80,50 30,80"></polygon>
          </svg>
        </button>

      </div>
    </div>
  </section>

  <!-- Top Controls -->
  <button id="musicToggle" class="control-btn" aria-pressed="false">üîà Music On</button>
  <button id="projectsBtn" class="control-btn" aria-haspopup="dialog" aria-controls="projectsModal">üìÅ Projects</button>
  <button id="carsBtn" class="control-btn" aria-haspopup="dialog" aria-controls="carsModal">üöó Fav Cars</button>

  <!-- Background Music -->
  <!-- NOTE: Ensure you have audio/Moonlight.mp3 -->
  <audio id="bgMusic" src="audio/Moonlight.mp3" loop preload="auto"></audio>

  <!-- Projects Modal (Parent Gated) -->
  <div id="projectsModal" class="modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="projectsTitle">
    <div class="panel" role="document">
      <h3 id="projectsTitle">Projects (Parent access)</h3>
      <div id="pinGate-projects">
        <label for="parentPin-projects">Parent PIN</label>
        <input id="parentPin-projects" type="password" inputmode="numeric" aria-label="Parent PIN" />
        <div class="actions">
          <button id="pinSubmit-projects" class="small">Unlock</button>
          <button id="pinClose-projects" class="small">Close</button>
        </div>
      </div>
      <div id="projectsContent" style="display:none">
        <p>Upload image or PDF, or paste a project link. Saved locally in this browser only.</p>
        <div class="grid">
          <div>
            <label for="fileInput">Upload file</label>
            <input id="fileInput" type="file" accept="image/*,application/pdf" />
          </div>
          <div>
            <label for="linkInput">Project link</label>
            <input id="linkInput" type="url" placeholder="https://example.com" />
          </div>
        </div>
        <div class="actions">
          <button id="saveFile" class="small">Save File</button>
          <button id="saveLink" class="small">Save Link</button>
          <button id="closePanel-projects" class="small">Done</button>
        </div>
        <div id="projectsList" class="projects-list" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Fav Cars Modal (Parent Gated) -->
  <div id="carsModal" class="modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="carsTitle">
    <div class="panel" role="document">
      <h3 id="carsTitle">Fav Cars (Parent access)</h3>
      <div id="pinGate-cars">
        <label for="carsPin">Parent PIN</label>
        <input id="carsPin" type="password" inputmode="numeric" aria-label="Parent PIN for cars" />
        <div class="actions">
          <button id="carsPinSubmit" class="small">Unlock</button>
          <button id="carsPinClose" class="small">Close</button>
        </div>
      </div>
      <div id="carsContent" style="display:none">
        <p>Add car: image, name, note, optional link. Saved locally.</p>
        <div class="grid">
          <div><label for="carFile">Car image</label><input id="carFile" type="file" accept="image/*" /></div>
          <div><label for="carName">Name</label><input id="carName" type="text" /></div>
          <div><label for="carNote">Note</label><input id="carNote" type="text" /></div>
          <div><label for="carLink">Link</label><input id="carLink" type="url" /></div>
        </div>
        <div class="actions">
          <button id="saveCar" class="small">Save Car</button>
          <button id="doneCars" class="small">Done</button>
        </div>
        <div id="carsList" class="projects-list" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Car Lightbox Modal -->
  <div id="carLightbox" class="modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="lightboxTitle">
    <div class="panel" style="max-width:820px">
      <button id="closeLightbox" class="small close-btn" aria-label="Close lightbox">&times;</button>
      <div id="lightboxContent" style="text-align:center">
         <!-- JS will populate this -->
      </div>
    </div>
  </div>

  <!-- Custom Message Modal (replaces alert()) -->
  <div id="messageModal" class="modal" style="display:none" role="alertdialog" aria-modal="true" aria-labelledby="messageTitle">
    <div class="panel" style="max-width:400px; text-align:center;">
      <h4 id="messageTitle" style="margin-top:0">Notice</h4>
      <p id="messageText"></p>
      <div id="messageActions" class="actions" style="justify-content:center">
        <button id="messageOK" class="small">OK</button>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal (replaces confirm()) -->
  <div id="confirmModal" class="modal" style="display:none" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="panel" style="max-width:400px; text-align:center;">
      <h4 id="confirmTitle" style="margin-top:0">Confirm Action</h4>
      <p id="confirmText"></p>
      <div id="confirmActions" class="actions" style="justify-content:center">
        <button id="confirmYes" class="small btn-danger">Yes, Delete</button>
        <button id="confirmNo" class="small">Cancel</button>
      </div>
    </div>
  </div>


  <!-- Inline JavaScript -->
  <script>
  (function() {
    "use strict";

    /* ---------- Custom Modals (Replacing alert/confirm) ---------- */
    const messageModal = document.getElementById('messageModal');
    const messageText = document.getElementById('messageText');
    const messageOK = document.getElementById('messageOK');

    /**
     * Shows a custom message modal.
     * @param {string} title - The title of the modal.
     * @param {string} message - The message to display.
     */
    function showMessage(title, message) {
      document.getElementById('messageTitle').textContent = title;
      messageText.textContent = message;
      messageModal.style.display = 'flex';
      messageOK.focus();
      messageOK.onclick = () => messageModal.style.display = 'none';
    }

    const confirmModal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    let confirmCallback = null;

    /**
     * Shows a custom confirmation modal.
     * @param {string} message - The confirmation question.
     * @param {function(boolean)} callback - Function to call with true (if yes) or false (if no).
     */
    function showConfirm(message, callback) {
      confirmText.textContent = message;
      confirmCallback = callback;
      confirmModal.style.display = 'flex';
      confirmNo.focus();
    }

    confirmYes.addEventListener('click', () => {
      confirmModal.style.display = 'none';
      if (confirmCallback) confirmCallback(true);
      confirmCallback = null;
    });

    confirmNo.addEventListener('click', () => {
      confirmModal.style.display = 'none';
      if (confirmCallback) confirmCallback(false);
      confirmCallback = null;
    });


    /* ---------- Music fade ---------- */
    const bg = document.getElementById('bgMusic');
    const musicBtn = document.getElementById('musicToggle');
    let musicPlaying = false, fadeTimer;

    function fadeVolume(from, to, ms, cb) {
      clearInterval(fadeTimer);
      const steps = 20, step = ms / steps;
      let i = 0;
      bg.volume = Math.max(0, Math.min(1, from));
      fadeTimer = setInterval(() => {
        i++;
        bg.volume = from + (to - from) * (i / steps);
        if (i >= steps) {
          clearInterval(fadeTimer);
          if (cb) cb();
        }
      }, step);
    }

    // Play music on first user interaction with the page
    document.body.addEventListener('click', function once() {
      document.body.removeEventListener('click', once);
      bg.volume = 0;
      bg.play().catch(() => {}); // Autoplay might fail, that's okay.
      fadeVolume(0, 0.35, 1200);
      musicPlaying = true;
      musicBtn.textContent = 'üîà Music On';
      musicBtn.setAttribute('aria-pressed', 'true');
    }, { once: true });

    musicBtn.addEventListener('click', () => {
      if (musicPlaying) {
        fadeVolume(bg.volume, 0, 800, () => bg.pause());
        musicBtn.textContent = 'üîá Music Off';
        musicBtn.setAttribute('aria-pressed', 'false');
      } else {
        bg.currentTime = bg.currentTime || 0;
        bg.play().catch(() => {});
        fadeVolume(0, 0.35, 1000);
        musicBtn.textContent = 'üîà Music On';
        musicBtn.setAttribute('aria-pressed', 'true');
      }
      musicPlaying = !musicPlaying;
    });

    /* ---------- Projects (lightweight local) ---------- */
    (function() {
      const PIN = '1234';
      const projectsBtn = document.getElementById('projectsBtn');
      const projectsModal = document.getElementById('projectsModal');
      const pinGate = document.getElementById('pinGate-projects');
      const projectsContent = document.getElementById('projectsContent');
      const parentPinInput = document.getElementById('parentPin-projects');
      const saveFileBtn = document.getElementById('saveFile');
      const saveLinkBtn = document.getElementById('saveLink');
      const closePanel = document.getElementById('closePanel-projects');
      const fileInput = document.getElementById('fileInput');
      const linkInput = document.getElementById('linkInput');
      const projectsList = document.getElementById('projectsList');

      function open() { projectsModal.style.display = 'flex'; parentPinInput.focus(); }
      function close() { projectsModal.style.display = 'none'; }
      
      projectsBtn.addEventListener('click', open);
      document.getElementById('pinClose-projects').addEventListener('click', close);
      closePanel.addEventListener('click', close);

      document.getElementById('pinSubmit-projects').addEventListener('click', () => {
        if (parentPinInput.value === PIN) {
          pinGate.style.display = 'none';
          projectsContent.style.display = 'block';
          load();
        } else {
          showMessage('Error', 'Incorrect Parent PIN. Please try again.');
          parentPinInput.focus();
        }
      });

      function get() { try { return JSON.parse(localStorage.getItem('devagneya_projects') || '[]') } catch (e) { return [] } }
      function set(v) { localStorage.setItem('devagneya_projects', JSON.stringify(v)) }

      saveFileBtn.addEventListener('click', () => {
        const f = fileInput.files[0];
        if (!f) {
          showMessage('Missing File', 'Please choose a file to upload.');
          return;
        }
        const r = new FileReader();
        r.onload = function(e) {
          const data = e.target.result;
          const proj = { id: Date.now(), kind: 'file', name: f.name, mime: f.type, data };
          const list = get();
          list.unshift(proj);
          set(list);
          fileInput.value = '';
          load();
        };
        r.readAsDataURL(f);
      });

      saveLinkBtn.addEventListener('click', () => {
        const url = linkInput.value.trim();
        if (!url) {
          showMessage('Missing URL', 'Please enter a project link URL.');
          return;
        }
        try {
          const u = new URL(url);
          const proj = { id: Date.now(), kind: 'link', name: u.hostname + u.pathname, url: u.href };
          const list = get();
          list.unshift(proj);
          set(list);
          linkInput.value = '';
          load();
        } catch (e) {
          showMessage('Invalid URL', 'The link you entered is not a valid URL.');
        }
      });

      function load() {
        const list = get();
        projectsList.innerHTML = '';
        if (list.length === 0) {
          projectsList.innerHTML = '<div>No projects yet</div>';
          return;
        }
        list.forEach(p => {
          const item = document.createElement('div');
          item.className = 'project-item';
          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          
          if (p.kind === 'file' && p.mime.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = p.data;
            img.alt = p.name;
            thumb.appendChild(img);
          } else if (p.kind === 'file' && p.mime === 'application/pdf') {
            thumb.innerHTML = '<small>PDF</small>';
          } else if (p.kind === 'link') {
            thumb.innerHTML = '<small>LINK</small>';
          }
          
          const meta = document.createElement('div');
          meta.className = 'meta';
          const title = document.createElement('strong');
          title.textContent = p.name || p.url;
          const sub = document.createElement('small');
          sub.textContent = p.kind === 'link' ? p.url : p.mime || '';
          meta.appendChild(title);
          meta.appendChild(sub);
          
          const actions = document.createElement('div');
          actions.className = 'project-actions';
          
          if (p.kind === 'link') {
            const open = document.createElement('button');
            open.className = 'small';
            open.textContent = 'Open';
            open.addEventListener('click', () => window.open(p.url, '_blank'));
            actions.appendChild(open);
          } else if (p.kind === 'file') {
            const open = document.createElement('button');
            open.className = 'small';
            open.textContent = 'Open';
            // NOTE: Opening PDF/Image files requires window.open() to prevent CORS/security issues inside the iframe.
            open.addEventListener('click', () => {
              const w = window.open();
              if (w) {
                w.document.write(`<title>${p.name}</title>`);
                if (p.mime.startsWith('image/')) {
                  w.document.write(`<img src="${p.data}" style="max-width:100%;">`);
                } else {
                  w.document.write(`<iframe src="${p.data}" style="width:100%;height:100vh;border:none"></iframe>`);
                }
                w.document.close(); // Finish writing
              } else {
                showMessage('Popup Blocked', 'Please allow popups in your browser to preview the file.');
              }
            });
            actions.appendChild(open);
          }
          
          const del = document.createElement('button');
          del.className = 'small btn-danger';
          del.textContent = 'Delete';
          del.addEventListener('click', () => {
            showConfirm(`Are you sure you want to permanently delete project: ${p.name}?`, (confirmed) => {
              if (confirmed) {
                const rem = get().filter(x => x.id !== p.id);
                set(rem);
                load();
              }
            });
          });
          actions.appendChild(del);
          
          item.appendChild(thumb);
          item.appendChild(meta);
          item.appendChild(actions);
          projectsList.appendChild(item);
        });
      }
    })();

    /* ---------- Fav Cars (local) ---------- */
    (function() {
      const PIN = '1234';
      const carsBtn = document.getElementById('carsBtn');
      const carsModal = document.getElementById('carsModal');
      const carsPinGate = document.getElementById('pinGate-cars');
      const carsContent = document.getElementById('carsContent');
      const carFile = document.getElementById('carFile');
      const carName = document.getElementById('carName');
      const carNote = document.getElementById('carNote');
      const carLink = document.getElementById('carLink');
      const saveCar = document.getElementById('saveCar');
      const doneCars = document.getElementById('doneCars');
      const carsList = document.getElementById('carsList');
      const carLightbox = document.getElementById('carLightbox');
      const lightboxContent = document.getElementById('lightboxContent');
      const closeLightboxBtn = document.getElementById('closeLightbox');

      function open() { carsModal.style.display = 'flex'; carsPinGate.querySelector('input').focus(); }
      function close() { carsModal.style.display = 'none'; }
      
      carsBtn.addEventListener('click', open);
      document.getElementById('carsPinClose').addEventListener('click', close);
      doneCars.addEventListener('click', close);

      document.getElementById('carsPinSubmit').addEventListener('click', () => {
        const v = document.getElementById('carsPin').value;
        if (v === PIN) {
          carsPinGate.style.display = 'none';
          carsContent.style.display = 'block';
          loadCars();
        } else {
          showMessage('Error', 'Incorrect Parent PIN. Please try again.');
          document.getElementById('carsPin').focus();
        }
      });

      function get() { try { return JSON.parse(localStorage.getItem('fav_cars') || '[]') } catch (e) { return [] } }
      function set(v) { localStorage.setItem('fav_cars', JSON.stringify(v)) }

      saveCar.addEventListener('click', () => {
        const f = carFile.files[0];
        const name = carName.value.trim() || 'Untitled';
        const note = carNote.value.trim();
        const link = carLink.value.trim();
        
        if (!f) {
          showMessage('Missing Image', 'Please choose an image for the car.');
          return;
        }
        const r = new FileReader();
        r.onload = function(e) {
          const data = e.target.result;
          const car = { id: Date.now(), name, note, link, data };
          const list = get();
          list.unshift(car);
          set(list);
          carFile.value = '';
          carName.value = '';
          carNote.value = '';
          carLink.value = '';
          loadCars();
        };
        r.readAsDataURL(f);
      });

      function loadCars() {
        const list = get();
        carsList.innerHTML = '';
        if (!list.length) {
          carsList.innerHTML = '<div>No favourite cars yet.</div>';
          return;
        }
        list.forEach(c => {
          const item = document.createElement('div');
          item.className = 'project-item car-item';
          
          const thumb = document.createElement('div');
          thumb.className = 'thumb';
          const img = document.createElement('img');
          img.src = c.data;
          img.alt = c.note || c.name; // Use note as alt text if available
          thumb.appendChild(img);
          
          const meta = document.createElement('div');
          meta.className = 'meta car-meta';
          const title = document.createElement('strong');
          title.textContent = c.name;
          const s = document.createElement('small');
          s.textContent = c.note || '';
          meta.appendChild(title);
          meta.appendChild(s);
          
          const actions = document.createElement('div');
          actions.className = 'project-actions';
          
          const view = document.createElement('button');
          view.className = 'small';
          view.textContent = 'View';
          view.addEventListener('click', () => openLightbox(c));
          actions.appendChild(view);
          
          if (c.link) {
            const go = document.createElement('button');
            go.className = 'small';
            go.textContent = 'Open';
            go.addEventListener('click', () => window.open(c.link, '_blank'));
            actions.appendChild(go);
          }
          
          const del = document.createElement('button');
          del.className = 'small btn-danger';
          del.textContent = 'Delete';
          del.addEventListener('click', () => {
            showConfirm(`Are you sure you want to permanently delete car: ${c.name}?`, (confirmed) => {
              if (confirmed) {
                const rem = get().filter(x => x.id !== c.id);
                set(rem);
                loadCars();
              }
            });
          });
          actions.appendChild(del);
          
          item.appendChild(thumb);
          item.appendChild(meta);
          item.appendChild(actions);
          carsList.appendChild(item);
        });
      }

      function openLightbox(car) {
        lightboxContent.innerHTML = ''; // Clear previous content
        
        const h = document.createElement('h3');
        h.id = "lightboxTitle"; // For accessibility
        h.textContent = car.name;
        
        const img = document.createElement('img');
        img.src = car.data;
        img.alt = car.note || car.name; // Use note as alt text if available
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';

        const p = document.createElement('p');
        p.textContent = car.note || '';
        
        lightboxContent.appendChild(h);
        lightboxContent.appendChild(img);
        lightboxContent.appendChild(p);
        
        if (car.link) {
          const a = document.createElement('a');
          a.href = car.link;
          a.target = '_blank';
          a.className = 'car-link';
          a.textContent = 'Open link';
          lightboxContent.appendChild(a);
        }
        carLightbox.style.display = 'flex';
        closeLightboxBtn.focus(); // Focus the close button
      }

      closeLightboxBtn.addEventListener('click', () => carLightbox.style.display = 'none');
    })();
    
    /* ---------- Home video "Click-to-Load" logic (Always loads within the page) ---------- */
    (function() {
      // The video ID has been confirmed from the user's input.
      const vidId = 'YMTpdIZYGdg'; 
      const videoBlock = document.getElementById('videoBlock');
      const playBtn = document.getElementById('videoPlayBtn');
      // NOTE: Ensure you have images/poster-fallback.jpg
      const localFallback = 'images/poster-fallback.jpg'; 

      // List of potential thumbnails, from highest to lowest quality
      const candidates = [
        `https://img.youtube.com/vi/${vidId}/maxresdefault.jpg`, // 1080p
        `https://img.youtube.com/vi/${vidId}/sddefault.jpg`,   // 640p
        `https://img.youtube.com/vi/${vidId}/hqdefault.jpg`,   // 480p
        `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`    // 320p
      ];

      /**
       * Finds the best available YouTube thumbnail and sets it as the background.
       */
      async function findWorkingThumbnail(urls) {
        for (const u of urls) {
          try {
            const res = await fetch(u, { method: 'GET', cache: 'no-store' });
            if (res.ok) {
              const blob = await res.blob();
              // A good thumbnail will be larger than a few KB
              if (blob.size > 2000) {
                return URL.createObjectURL(blob);
              }
            }
          } catch (e) {
              // Network or CORS error, proceed to next candidate
          }
        }
        return null; // No thumbnail found
      }

      (async function applyThumbnail() {
        const url = await findWorkingThumbnail(candidates);
        videoBlock.style.backgroundImage = `url(${url || localFallback})`;
      })();

      /**
       * Loads the YouTube iframe and plays it. This ensures the video stays embedded.
       */
      function loadVideo() {
        // Clear the block (remove play button and thumbnail background)
        videoBlock.innerHTML = ''; 
        videoBlock.style.backgroundImage = 'none';
        
        const iframe = document.createElement('iframe');
        // Add enablejsapi=1 for future controls, and autoplay=1 to play on load
        iframe.src = `https://www.youtube.com/embed/${vidId}?enablejsapi=1&rel=0&modestbranding=1&autoplay=1`;
        iframe.title = "GreenCityProject";
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        
        videoBlock.appendChild(iframe);
      }
      
      playBtn.addEventListener('click', loadVideo);
      
      // Also allow keyboard interaction (Enter/Space) on the video block
      videoBlock.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          loadVideo();
        }
      });

    })();

    /* ---------- Generic modal helpers ---------- */
    // Close any open modal by clicking on the backdrop
    document.addEventListener('click', (e) => {
      document.querySelectorAll('.modal').forEach(m => {
        if (m.style.display === 'flex' && e.target === m) {
          m.style.display = 'none';
        }
      });
    });
    
    // Close any open modal with the Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(m => {
          m.style.display = 'none';
        });
      }
    });

  })();
  </script>
</body>
</html>
